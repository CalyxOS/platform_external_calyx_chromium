From: Tommy Webb <tommy@calyxinstitute.org>
Date: Mon, 29 Jul 2024 20:18:04 +0000
Subject: UX changes to "Add custom tab intents privacy option"

Remove the "Allow custom tab intents" toggle. It is now tied to
the "Open external links in incognito" toggle.

This is done for a few reasons:
1. Turning off Custom Tabs seems fairly niche, and we only initially
   wanted to add the external-links-in-incognito part.
2. We accidentally kept Cromite's default-disabled status for the
   Custom Tabs toggle and don't have a great way to migrate out.
3. Custom Tabs are supposed to be turned off when external incognito
   links is on. This is the behavior described but not what happens.
   Activity from third-party apps via Custom Tabs could unexpectedly
   leak into the user's browser history. Simply removing the separate
   toggle fixes this automatically, no UI changes needed.

Change-Id: Id11bab82a3a634080165bb51a3533f782bd6ccad
---
 .../android/java/res/xml/privacy_preferences.xml  | 10 ----------
 .../chrome/browser/LaunchIntentDispatcher.java    |  5 +++--
 .../browser/privacy/settings/PrivacySettings.java | 11 -----------
 .../Add-custom-tab-intents-privacy-option.grdp    | 15 ---------------
 4 files changed, 3 insertions(+), 38 deletions(-)

diff --git a/chrome/android/java/res/xml/privacy_preferences.xml b/chrome/android/java/res/xml/privacy_preferences.xml
--- a/chrome/android/java/res/xml/privacy_preferences.xml
+++ b/chrome/android/java/res/xml/privacy_preferences.xml
@@ -57,16 +57,6 @@ found in the LICENSE file.
         android:key="cromite_flags"
         android:title="@string/cromite_flags_title"
         app:url="@string/cromite_flags_url" />
-    <org.chromium.components.browser_ui.settings.ChromeSwitchPreference
-        android:key="allow_custom_tab_intents"
-        android:title="@string/allow_custom_tab_intents_title"
-        android:summary="@string/allow_custom_tab_intents_summary"
-        android:defaultValue="false" />
-    <org.chromium.components.browser_ui.settings.ChromeSwitchPreference
-        android:title="@string/uses_separate_storagepartition_for_cct_title"
-        android:summary="@string/uses_separate_storagepartition_for_cct_summary"
-        app:featureName="maylaunchurl-uses-separate-storage-partition"
-        app:needRestart="true" />
     <org.chromium.components.browser_ui.settings.ChromeSwitchPreference
         android:key="open_external_links_incognito"
         android:title="@string/open_external_links_incognito_title"
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
@@ -270,9 +270,10 @@ public class LaunchIntentDispatcher {
     @OptIn(markerClass = ExperimentalAuthTab.class)
     public static boolean isCustomTabIntent(Intent intent) {
         if (intent == null) return false;
-        if (!ContextUtils.getAppSharedPreferences()
-                .getBoolean(PrivacySettings.PREF_ALLOW_CUSTOM_TAB_INTENTS, false))
+        if (ContextUtils.getAppSharedPreferences()
+                .getBoolean(PrivacySettings.PREF_OPEN_EXTERNAL_LINKS_INCOGNITO, false)) {
             return false;
+        }
         Log.w(
                 TAG,
                 "CustomTabsIntent#shouldAlwaysUseBrowserUI() = "
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/privacy/settings/PrivacySettings.java b/chrome/android/java/src/org/chromium/chrome/browser/privacy/settings/PrivacySettings.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/privacy/settings/PrivacySettings.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/privacy/settings/PrivacySettings.java
@@ -110,7 +110,6 @@ public class PrivacySettings extends ChromeBaseSettingsFragment
     private IncognitoLockSettings mIncognitoLockSettings;
     private final ObservableSupplierImpl<String> mPageTitle = new ObservableSupplierImpl<>();
 
-    private ChromeSwitchPreference allowCustomTabIntentsPref;
     private ChromeSwitchPreference openExternalLinksPref;
 
     @Override
@@ -338,7 +337,6 @@ public class PrivacySettings extends ChromeBaseSettingsFragment
                 new SpanApplier.SpanInfo("<link2>", "</link2>", servicesLink));
     }
 
-    public static final String PREF_ALLOW_CUSTOM_TAB_INTENTS = "allow_custom_tab_intents";
     public static final String PREF_OPEN_EXTERNAL_LINKS_INCOGNITO = "open_external_links_incognito";
 
     @Override
@@ -357,10 +355,6 @@ public class PrivacySettings extends ChromeBaseSettingsFragment
         } else if (PREF_SEARCH_SUGGESTIONS.equals(key)) {
             UserPrefs.get(getProfile())
                     .setBoolean(Pref.SEARCH_SUGGEST_ENABLED, (boolean) newValue);
-        } else if (PREF_ALLOW_CUSTOM_TAB_INTENTS.equals(key)) {
-            SharedPreferences.Editor sharedPreferencesEditor = ContextUtils.getAppSharedPreferences().edit();
-            sharedPreferencesEditor.putBoolean(PREF_ALLOW_CUSTOM_TAB_INTENTS, (boolean)newValue);
-            sharedPreferencesEditor.apply();
             // check default browser
             if ((boolean)newValue) {
                 ResolveInfo info = PackageManagerUtils.resolveDefaultWebBrowserActivity();
@@ -414,11 +408,6 @@ public class PrivacySettings extends ChromeBaseSettingsFragment
                     UserPrefs.get(getProfile()).getBoolean(Pref.CAN_MAKE_PAYMENT_ENABLED));
         }
 
-        allowCustomTabIntentsPref =
-                (ChromeSwitchPreference) findPreference(PREF_ALLOW_CUSTOM_TAB_INTENTS);
-        allowCustomTabIntentsPref.setOnPreferenceChangeListener(this);
-        allowCustomTabIntentsPref.setManagedPreferenceDelegate(mManagedPreferenceDelegate);
-
         openExternalLinksPref =
                 (ChromeSwitchPreference) findPreference(PREF_OPEN_EXTERNAL_LINKS_INCOGNITO);
         openExternalLinksPref.setOnPreferenceChangeListener(this);
diff --git a/chrome/browser/ui/android/strings/cromite_android_chrome_strings_grd/Add-custom-tab-intents-privacy-option.grdp b/chrome/browser/ui/android/strings/cromite_android_chrome_strings_grd/Add-custom-tab-intents-privacy-option.grdp
--- a/chrome/browser/ui/android/strings/cromite_android_chrome_strings_grd/Add-custom-tab-intents-privacy-option.grdp
+++ b/chrome/browser/ui/android/strings/cromite_android_chrome_strings_grd/Add-custom-tab-intents-privacy-option.grdp
@@ -1,20 +1,5 @@
 <?xml version="1.0" encoding="utf-8"?>
 <grit-part>
-    <!-- Allow custom tab intents -->
-    <message name="IDS_ALLOW_CUSTOM_TAB_INTENTS_TITLE" desc="Text for 'Allow custom tab intents' settings-privacy option.">
-        Allow custom tab intents.
-    </message>
-    <message name="IDS_ALLOW_CUSTOM_TAB_INTENTS_SUMMARY" desc="Summary text for 'Allow custom tab intents' settings-privacy option.">
-        Allow applications to open custom tab intents, similar to webview. To work, Cromite must be set as the default browser.
-    </message>
-
-    <message name="IDS_USES_SEPARATE_STORAGEPARTITION_FOR_CCT_TITLE" desc="Text for 'Use ephemeral mode for CCT' settings-privacy option.">
-        Use ephemeral mode for CCT
-    </message>
-    <message name="IDS_USES_SEPARATE_STORAGEPARTITION_FOR_CCT_SUMMARY" desc="Summary text for 'Use ephemeral mode for CCT' settings-privacy option.">
-        Use a separate storage partition when opening custom tab intents
-    </message>
-
     <!-- Open External Links in Incognito -->
     <message name="IDS_OPEN_EXTERNAL_LINKS_INCOGNITO_TITLE" desc="Text for 'Open external links in incognito' settings-privacy option.">
         Open external links in incognito
-- 

