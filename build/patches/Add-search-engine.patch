From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Mon, 11 Dec 2017 22:42:11 +0100
Subject: Add search engine

Add a Google search engine that forces languages to English,
disable from all its searches RLZ and field experiments querystring parameters.
Add DuckDuckGo Lite

License: GPL-2.0-or-later - https://spdx.org/licenses/GPL-2.0-or-later.html

Change-Id: I3d17ddba87a86200ce0b4484b9673045370f0ddc
---
 .../search_engine_choice/default_favicon.png  | Bin 0 -> 903 bytes
 ...search_engine_choice_scaled_resources.grdp |   1 +
 components/search_engines/BUILD.gn            |   3 ++
 components/search_engines/cromite/BUILD.gn    |  12 ++++++
 .../cromite/cromite_prepopulated_engines.json |  37 ++++++++++++++++++
 .../search_engine_choice_utils.cc             |   5 +--
 .../search_engines/search_engine_type.h       |   5 +++
 .../template_url_prepopulate_data.cc          |  21 +++++++++-
 .../template_url_prepopulate_data.h           |   9 -----
 tools/json_to_struct/json_to_struct.gni       |   9 +++++
 tools/json_to_struct/json_to_struct.py        |  26 ++++++++----
 tools/json_to_struct/struct_generator.py      |  10 +++--
 tools/variations/fieldtrial_to_struct.py      |   4 +-
 13 files changed, 114 insertions(+), 28 deletions(-)
 create mode 100644 components/resources/default_100_percent/search_engine_choice/default_favicon.png
 create mode 100644 components/search_engines/cromite/BUILD.gn
 create mode 100644 components/search_engines/cromite/cromite_prepopulated_engines.json

diff --git a/components/resources/default_100_percent/search_engine_choice/default_favicon.png b/components/resources/default_100_percent/search_engine_choice/default_favicon.png
new file mode 100644
index 0000000000000000000000000000000000000000..6533419f2d6b40f7735054dec62c51ddf1ee1201
GIT binary patch
literal 903
zcmeAS@N?(olHy`uVBq!ia0y~yU@!n-4mJh`hH$2z?F<aeex5FlAr-gYMw(8!V<Yg-
z@XQ(C9p1ues}5aB+dA#d<dUAZj`Gi}YIkrNgTUfvsjE-CzPje=g0J^vqUQbF!hFBy
z-!IRwJ&#;x%$c*GD7LBVbjwF~&QtfbeomRR{e$@rc^l^Q|7_fh>l{v6r#?yV5zxAK
z@SZ$Vn$`1KA)h(^bKgCm@QL#t>-(NNA2KheT?@_IAf0Hz#j!`a#O1MGWu+~Lu)jm(
z6ecT&>7kEh+x-KVf3|D>#P3xm818lGQ`^qGJaf%d=H-hPDJE}HPu#hf^Xc<54ISSX
zT%PyQuWEXro2{aW`?KfI&AF=lClxmSRB=#$!S~iI(|=y)_m-2hHf`GUYv#SrKR-X;
zFWhtg(C#S}{AMY#8(!AT3-~z0;Ntlo3QKZ?)zmg|<(%NijCrP%{8QHG?e{&Z|E=@h
zsiYpzVXg4p@jz_%#mam7p@&Y+miTX)@iTL_rdX)@f(<`@?P<L2;G?nNdd~9j4V(uv
zzg%u_Fl9dPt-MNbeoqGb2jTr8oa)(S3^m0eu6#Mhj34~iCn%rgl-n<?*ig>)ZgF^o
zMi2+X`$bEo81q<S?xtVXOZinRsLHUx(Bo$+??!D^zJ@glK4Cw(L{A@P7MR{__s?C5
z!SzheM5kGktyOdwHW)tm^5b^CIm7BLtOq`OMMo4Y-tNe-<q!Xq8(HxWKOKFRs~-O#
zoWF-rLBv)$Bqs3RPR*BHS&vS|HBO!NQFdlm*rbz|OIEDtlt1gXGoa(r{#&2BZY_Ju
zA7dxh6xC?Ih`~1SynT34*vUytrr#EySJ?8RuRu|^!<oB4$t!hw&Rt$14yBH*CRyHP
zp`oFFC&%vb==4||rMOw`f!<Aqfa>yOu9<GCI>!zNt@-E>-*8M}MT^_B943oKRtA<!
z`Lo&=T>i##N$1eFkl-Wp6JBh&b|K;)OPpf*I@2F*Zuy$IpMLy)cC5SZ!oEjQry7>s
z3vpQa_~gU7NhMDig!dX4G%RY%cqN!TRY2wRjfzwHkB)1-I5@4A;enaKri1+3J}f@^
zfx#q6J^R4l4~t!&6kJzh&<L9FTrt$m>dw*L>xyST_HrKMZt$&&OH@C<dKLR$786&8
zGeLLKrpG0kR?auF+xOr?%{TWr!=uw{%+^O<m3uqObl;0(>no1F=3eIdwOUtn-AM)p
O1_n=8KbLh*2~7aK3aM`Z

literal 0
HcmV?d00001

diff --git a/components/resources/search_engine_choice_scaled_resources.grdp b/components/resources/search_engine_choice_scaled_resources.grdp
--- a/components/resources/search_engine_choice_scaled_resources.grdp
+++ b/components/resources/search_engine_choice_scaled_resources.grdp
@@ -5,6 +5,7 @@
   <if expr="_google_chrome">
     <structure type="chrome_scaled_image" name="IDR_GOOGLE_COM_PNG" file="google_chrome/google_search_logo.png" />
   </if>
+  <structure type="chrome_scaled_image" name="IDR_GOOGLEEN_PNG" file="search_engine_choice/default_favicon.png" />
   <structure type="chrome_scaled_image" name="IDR_AR_YAHOO_COM_PNG" file="search_engine_choice/yahoo_com.png" />
   <structure type="chrome_scaled_image" name="IDR_AT_YAHOO_COM_PNG" file="search_engine_choice/yahoo_com.png" />
   <structure type="chrome_scaled_image" name="IDR_AU_YAHOO_COM_PNG" file="search_engine_choice/yahoo_com.png" />
diff --git a/components/search_engines/BUILD.gn b/components/search_engines/BUILD.gn
--- a/components/search_engines/BUILD.gn
+++ b/components/search_engines/BUILD.gn
@@ -72,6 +72,7 @@ static_library("search_engines") {
     "//third_party/metrics_proto",
     "//third_party/omnibox_proto",
     "//third_party/search_engines_data:prepopulated_engines",
+    "cromite:cromite_prepopulated_engines",
   ]
 
   deps = [
@@ -158,6 +159,7 @@ source_set("search_engine_utils") {
     ":search_engine_type",
     "//components/google/core/common",
     "//third_party/search_engines_data:prepopulated_engines",
+    "cromite:cromite_prepopulated_engines",
   ]
 
   deps = [ "//url" ]
@@ -246,6 +248,7 @@ source_set("unit_tests") {
     "//testing/gmock",
     "//testing/gtest",
     "//third_party/search_engines_data:prepopulated_engines",
+    "cromite:cromite_prepopulated_engines",
     "//ui/base",
     "//url",
   ]
diff --git a/components/search_engines/cromite/BUILD.gn b/components/search_engines/cromite/BUILD.gn
new file mode 100644
--- /dev/null
+++ b/components/search_engines/cromite/BUILD.gn
@@ -0,0 +1,12 @@
+import("//tools/json_to_struct/json_to_struct.gni")
+
+json_to_struct("cromite_prepopulated_engines") {
+  visibility = [ "//components/search_engines:*" ]
+
+  source = "cromite_prepopulated_engines.json"
+  schema_file = "//third_party/search_engines_data/prepopulated_engines_schema.json"
+  namespace = "TemplateURLPrepopulateData"
+  excludetype = true
+
+  deps = [ "//base" ]
+}
diff --git a/components/search_engines/cromite/cromite_prepopulated_engines.json b/components/search_engines/cromite/cromite_prepopulated_engines.json
new file mode 100644
--- /dev/null
+++ b/components/search_engines/cromite/cromite_prepopulated_engines.json
@@ -0,0 +1,37 @@
+{
+    "additionals_includes": {
+        "third_party/search_engines_data/resources/definitions/prepopulated_engines.h": ""
+    },
+    "elements": {
+        "duckduckgo_light": {
+            "name": "DuckDuckGo Light",
+            "keyword": "duckduckgo.com/lite",
+            "favicon_url": "https://duckduckgo.com/favicon.ico",
+            "search_url": "https://duckduckgo.com/lite/?q={searchTerms}",
+            "suggest_url": "https://duckduckgo.com/ac/?q={searchTerms}&type=list",
+            "type": "SEARCH_ENGINE_DUCKDUCKGOLIGHT",
+            "id": 12
+        },
+
+        "googleen": {
+            "name": "Google in English",
+            "keyword": "googleen",
+            "favicon_url": "https://www.google.com/favicon.ico",
+            "search_url": "{google:baseURL}search?q={searchTerms}&ie={inputEncoding}&hl=en",
+            "suggest_url": "{google:baseSuggestURL}search?client={google:suggestClient}&q={searchTerms}&hl=en",
+            "image_url": "{google:baseURL}searchbyimage/upload?hl=en",
+            "new_tab_url": "{google:baseURL}_/chrome/newtab?hl=en&ie={inputEncoding}",
+            "contextual_search_url": "{google:baseURL}_/contextualsearch?{google:contextualSearchVersion}{google:contextualSearchContextData}&hl=en",
+            "image_url_post_params": "encoded_image={google:imageThumbnail},image_url={google:imageURL},sbisrc={google:imageSearchSource},original_width={google:imageOriginalWidth},original_height={google:imageOriginalHeight}",
+            "alternate_urls": [
+              "{google:baseURL}?hl=en#q={searchTerms}",
+              "{google:baseURL}search?hl=en#q={searchTerms}",
+              "{google:baseURL}webhp?hl=en#q={searchTerms}",
+              "{google:baseURL}s?hl=en#q={searchTerms}",
+              "{google:baseURL}s?hl=en&q={searchTerms}"
+            ],
+            "type": "SEARCH_ENGINE_GOOGLE_EN",
+            "id": 13
+        }
+    }
+}
diff --git a/components/search_engines/search_engine_choice/search_engine_choice_utils.cc b/components/search_engines/search_engine_choice/search_engine_choice_utils.cc
--- a/components/search_engines/search_engine_choice/search_engine_choice_utils.cc
+++ b/components/search_engines/search_engine_choice/search_engine_choice_utils.cc
@@ -187,10 +187,7 @@ void RecordChoiceScreenDefaultSearchProviderType(
 }
 
 void RecordChoiceScreenSelectedIndex(int selected_engine_index) {
-  base::UmaHistogramExactLinear(
-      kSearchEngineChoiceScreenSelectedEngineIndexHistogram,
-      selected_engine_index,
-      TemplateURLPrepopulateData::kMaxEeaPrepopulatedEngines);
+  // do nothing in Cromite
 }
 
 void RecordChoiceScreenPositionsCountryMismatch(bool has_mismatch) {
diff --git a/components/search_engines/search_engine_type.h b/components/search_engines/search_engine_type.h
--- a/components/search_engines/search_engine_type.h
+++ b/components/search_engines/search_engine_type.h
@@ -97,11 +97,16 @@ enum SearchEngineType {
   SEARCH_ENGINE_MCAFEE = 77,
   SEARCH_ENGINE_FREESPOKE = 78,
   SEARCH_ENGINE_KAGI = 79,
+  SEARCH_ENGINE_GOOGLE_EN = 80,
+  SEARCH_ENGINE_DUCKDUCKGOLIGHT = 81,
 
   SEARCH_ENGINE_MAX  // Bounding value needed for UMA histogram macro.
 };
 // LINT.ThenChange(//tools/metrics/histograms/enums.xml:OmniboxSearchEngineType)
 
+static_assert(SEARCH_ENGINE_DUCKDUCKGOLIGHT == (SEARCH_ENGINE_MAX - 1),
+              "Please check this patch");
+
 // Enum to record the type of search engine a user used in keyword mode. This
 // should be kept aligned with the `OmniboxBuiltinEngineType` enum in enums.xml.
 // Entries should not be renumbered and numeric values should never be reused.
diff --git a/components/search_engines/template_url_prepopulate_data.cc b/components/search_engines/template_url_prepopulate_data.cc
--- a/components/search_engines/template_url_prepopulate_data.cc
+++ b/components/search_engines/template_url_prepopulate_data.cc
@@ -28,6 +28,8 @@
 #include "components/search_engines/template_url_data_util.h"
 #include "third_party/search_engines_data/resources/definitions/prepopulated_engines.h"
 
+#include "components/search_engines/cromite/cromite_prepopulated_engines.h"
+
 namespace TemplateURLPrepopulateData {
 
 // Helpers --------------------------------------------------------------------
@@ -123,7 +125,7 @@ int GetDataVersion(PrefService* prefs) {
       kCurrentDataVersion;
 }
 
-std::vector<std::unique_ptr<TemplateURLData>> GetPrepopulatedEngines(
+std::vector<std::unique_ptr<TemplateURLData>> GetPrepopulatedEnginesChromium(
     PrefService& prefs,
     std::vector<const TemplateURLPrepopulateData::PrepopulatedEngine*>
         regional_prepopulated_engines) {
@@ -139,6 +141,17 @@ std::vector<std::unique_ptr<TemplateURLData>> GetPrepopulatedEngines(
                         &PrepopulatedEngineToTemplateURLData);
 }
 
+std::vector<std::unique_ptr<TemplateURLData>> GetPrepopulatedEngines(
+    PrefService& prefs,
+    std::vector<const TemplateURLPrepopulateData::PrepopulatedEngine*>
+        regional_prepopulated_engines) {
+  std::vector<std::unique_ptr<TemplateURLData>> t_urls =
+    GetPrepopulatedEnginesChromium(prefs, regional_prepopulated_engines);
+  t_urls.push_back(TemplateURLDataFromPrepopulatedEngine(googleen));
+  t_urls.push_back(TemplateURLDataFromPrepopulatedEngine(duckduckgo_light));
+  return t_urls;
+}
+
 std::unique_ptr<TemplateURLData> GetPrepopulatedEngine(
     PrefService& prefs,
     std::vector<const TemplateURLPrepopulateData::PrepopulatedEngine*>
@@ -160,9 +173,13 @@ std::vector<std::unique_ptr<TemplateURLData>> GetLocalPrepopulatedEngines(
     return std::vector<std::unique_ptr<TemplateURLData>>();
   }
 
-  return base::ToVector(
+  std::vector<std::unique_ptr<TemplateURLData>> t_urls =
+    base::ToVector(
       regional_capabilities::GetPrepopulatedEngines(country_id, prefs),
       &PrepopulatedEngineToTemplateURLData);
+  t_urls.push_back(TemplateURLDataFromPrepopulatedEngine(googleen));
+  t_urls.push_back(TemplateURLDataFromPrepopulatedEngine(duckduckgo_light));
+  return t_urls;
 }
 
 #endif
diff --git a/components/search_engines/template_url_prepopulate_data.h b/components/search_engines/template_url_prepopulate_data.h
--- a/components/search_engines/template_url_prepopulate_data.h
+++ b/components/search_engines/template_url_prepopulate_data.h
@@ -27,15 +27,6 @@ struct PrepopulatedEngine;
 
 extern const int kMaxPrepopulatedEngineID;
 
-// The maximum number of prepopulated search engines that can be returned in
-// any of the EEA countries by `GetPrepopulatedEngines()`.
-//
-// Note: If this is increased, please also increase the declared variant count
-// for the `Search.ChoiceScreenShowedEngineAt.Index{Index}` histogram.
-// TODO(crbug.com/408932087): Investigate moving it to the file that actually
-// populates these, `//c/regional_capabilities/r*c*_util.cc`.
-inline constexpr size_t kMaxEeaPrepopulatedEngines = 8;
-
 // The maximum number of prepopulated search engines that can be returned in
 // in the rest of the world by `GetPrepopulatedEngines()`.
 // TODO(crbug.com/408932087): Investigate deduping it with the constant
diff --git a/tools/json_to_struct/json_to_struct.gni b/tools/json_to_struct/json_to_struct.gni
--- a/tools/json_to_struct/json_to_struct.gni
+++ b/tools/json_to_struct/json_to_struct.gni
@@ -39,6 +39,11 @@ template("json_to_struct") {
   action_name = target_name + "_action"
   source_set_name = target_name
 
+  excludetype = false
+  if (defined(invoker.excludetype)) {
+    excludetype = invoker.excludetype
+  }
+
   action(action_name) {
     visibility = [ ":$source_set_name" ]
     script = "//tools/json_to_struct/json_to_struct.py"
@@ -61,6 +66,10 @@ template("json_to_struct") {
       "--namespace=" + invoker.namespace,
       "--schema=" + rebase_path(invoker.schema_file, root_build_dir),
     ]
+
+    if (excludetype) {
+      args += [ "--excludetype=yes" ]
+    }
   }
 
   source_set(source_set_name) {
diff --git a/tools/json_to_struct/json_to_struct.py b/tools/json_to_struct/json_to_struct.py
--- a/tools/json_to_struct/json_to_struct.py
+++ b/tools/json_to_struct/json_to_struct.py
@@ -103,7 +103,7 @@ def _GenerateHeaderGuard(h_filename):
   return re.sub(u'^_*', '', result) + u'_'  # Remove leading underscores.
 
 
-def _GenerateH(basepath, fileroot, head, namespace, schema, description):
+def _GenerateH(basepath, fileroot, head, namespace, schema, description, excludetype):
   """Generates the .h file containing the definition of the structure specified
   by the schema.
 
@@ -139,11 +139,15 @@ def _GenerateH(basepath, fileroot, head, namespace, schema, description):
       f.write(u'#include "%s"\n' % header)
     f.write(u'\n')
 
+    for header in description.get(u'additionals_includes', []):
+      f.write(u'#include "%s"\n' % header)
+    f.write(u'\n')
+
     if namespace:
       f.write(u'namespace %s {\n' % namespace)
       f.write(u'\n')
 
-    f.write(struct_generator.GenerateStruct(
+    f.write(struct_generator.GenerateStruct(excludetype,
       schema['type_name'], schema['schema']))
     f.write(u'\n')
 
@@ -170,7 +174,7 @@ def _GenerateH(basepath, fileroot, head, namespace, schema, description):
     f.write(u'#endif  // %s\n' % header_guard)
 
 
-def _GenerateCC(basepath, fileroot, head, namespace, schema, description):
+def _GenerateCC(basepath, fileroot, head, namespace, schema, description, excludetype):
   """Generates the .cc file containing the static initializers for the
   of the elements specified in the description.
 
@@ -205,7 +209,7 @@ def _GenerateCC(basepath, fileroot, head, namespace, schema, description):
     f.write(element_generator.GenerateElements(schema['type_name'],
         schema['schema'], description))
 
-    if not aggregation.export_items:
+    if excludetype == False and not aggregation.export_items:
       f.write('\n}  // anonymous namespace \n\n')
 
     aggregated = GenerateCCAggregation(schema['type_name'], aggregation)
@@ -292,7 +296,7 @@ def GenerateClass(basepath,
 
 
 def GenerateStruct(basepath, output_root, namespace, schema, description,
-                   description_filename, schema_filename, year=None):
+                   description_filename, schema_filename, excludetype, year):
   """Generates a C++ struct from a JSON description.
 
   Args:
@@ -311,8 +315,8 @@ def GenerateStruct(basepath, output_root, namespace, schema, description,
   """
   year = int(year) if year else datetime.now().year
   head = HEAD % (year, schema_filename, description_filename)
-  _GenerateH(basepath, output_root, head, namespace, schema, description)
-  _GenerateCC(basepath, output_root, head, namespace, schema, description)
+  _GenerateH(basepath, output_root, head, namespace, schema, description, excludetype)
+  _GenerateCC(basepath, output_root, head, namespace, schema, description, excludetype)
 
 if __name__ == '__main__':
   parser = optparse.OptionParser(
@@ -327,11 +331,17 @@ if __name__ == '__main__':
   parser.add_option('-s', '--schema', help='path to the schema file, '
       'mandatory.')
   parser.add_option('-o', '--output', help='output filename, ')
+  parser.add_option('-x', '--excludetype', help='exclude type generator, ')
   (opts, args) = parser.parse_args()
 
   if not opts.schema:
     parser.error('You must specify a --schema.')
 
+  if not opts.excludetype:
+    opts.excludetype = False
+  else:
+    opts.excludetype = True
+
   description_filename = os.path.normpath(args[0])
   root, ext = os.path.splitext(description_filename)
   shortroot = opts.output if opts.output else os.path.split(root)[1]
@@ -348,4 +358,4 @@ if __name__ == '__main__':
   schema = _Load(opts.schema)
   description = _Load(description_filename)
   GenerateStruct(basepath, output_root, opts.namespace, schema, description,
-                 description_filename, opts.schema)
+                 description_filename, opts.schema, opts.excludetype, datetime.now().year)
diff --git a/tools/json_to_struct/struct_generator.py b/tools/json_to_struct/struct_generator.py
--- a/tools/json_to_struct/struct_generator.py
+++ b/tools/json_to_struct/struct_generator.py
@@ -30,20 +30,24 @@ def GenerateField(field_info):
   else:
     raise RuntimeError('Unknown field type "%s"' % type)
 
-def GenerateStruct(type_name, schema):
+def GenerateStruct(excludetype, type_name, schema):
   """Generate a string defining a structure containing the fields specified in
   the schema list.
   """
   lines = []
+  if excludetype:
+    lines.append('struct %s;' % type_name)
+    return '\n'.join(lines) + '\n'
+
   lines.append('struct %s {' % type_name)
   for field_info in schema:
     if field_info['type'] == 'struct':
-      lines.insert(0, GenerateStruct(field_info['type_name'],
+      lines.insert(0, GenerateStruct(excludetype, field_info['type_name'],
                                      field_info['fields']))
     elif (field_info['type'] == 'array'
           and field_info['contents']['type'] == 'struct'):
       contents = field_info['contents']
-      lines.insert(0, GenerateStruct(contents['type_name'],
+      lines.insert(0, GenerateStruct(excludetype, contents['type_name'],
                                      contents['fields']))
     lines.append('  ' + GenerateField(field_info) + ';')
   lines.append('};')
diff --git a/tools/variations/fieldtrial_to_struct.py b/tools/variations/fieldtrial_to_struct.py
--- a/tools/variations/fieldtrial_to_struct.py
+++ b/tools/variations/fieldtrial_to_struct.py
@@ -235,14 +235,14 @@ def main(arguments):
   json_to_struct.GenerateStruct(
       basepath, output_root, opts.namespace, schema, description,
       os.path.split(description_filename)[1], os.path.split(opts.schema)[1],
-      opts.year)
+      False, opts.year)
 
   # TODO(peilinwang) filter the schema by platform, form_factor, etc.
   if opts.java:
     json_to_struct.GenerateClass(basepath, output_root, opts.namespace, schema,
                                  description,
                                  os.path.split(description_filename)[1],
-                                 os.path.split(opts.schema)[1], opts.year)
+                                 os.path.split(opts.schema)[1], False, opts.year)
 
 
 if __name__ == '__main__':
-- 

