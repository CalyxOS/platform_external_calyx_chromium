From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Serg <serg.zhukovsky@gmail.com>
Date: Tue, 31 Jan 2017 22:12:27 -0500
Subject: Add exit menu item

Corrected Exit functionality

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
Change-Id: I04b24400b97b1a8e4857b3a8be693746fd782eeb
---
 chrome/android/java/res/menu/main_menu.xml    |   6 ++++++
 .../chrome/browser/ApplicationLifetime.java   |   2 ++
 .../chrome/browser/ChromeTabbedActivity.java  |   4 ++++
 .../chrome/browser/app/ChromeActivity.java    |   6 ++++++
 .../strings/android_chrome_strings.grd        | Bin 527300 -> 527418 bytes
 5 files changed, 18 insertions(+)

diff --git a/chrome/android/java/res/menu/main_menu.xml b/chrome/android/java/res/menu/main_menu.xml
--- a/chrome/android/java/res/menu/main_menu.xml
+++ b/chrome/android/java/res/menu/main_menu.xml
@@ -160,6 +160,9 @@ found in the LICENSE file.
         <item android:id="@+id/managed_by_menu_id"
             android:title="@string/managed_browser"
             android:icon="@drawable/ic_business" />
+        <item android:id="@+id/exit_id"
+            android:title="@string/menu_exit"
+            android:icon="@drawable/ic_exit_to_app_white_24dp" />
     </group>
 
     <!-- Items shown only in the tab switcher -->
@@ -186,6 +189,9 @@ found in the LICENSE file.
         <item android:id="@id/preferences_id"
             android:title="@string/menu_settings"
             android:icon="@drawable/settings_cog" />
+        <item android:id="@+id/exit_id"
+            android:title="@string/menu_exit"
+            android:icon="@drawable/ic_exit_to_app_white_24dp" />
     </group>
 
     <!-- Items shown only when the tablet has no visible tabs -->
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ApplicationLifetime.java b/chrome/android/java/src/org/chromium/chrome/browser/ApplicationLifetime.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ApplicationLifetime.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ApplicationLifetime.java
@@ -7,6 +7,7 @@ package org.chromium.chrome.browser;
 import org.jni_zero.CalledByNative;
 
 import org.chromium.base.ObserverList;
+import org.chromium.chrome.browser.incognito.IncognitoNotificationManager;
 
 /** Watches for when Chrome is told to restart itself. */
 public class ApplicationLifetime {
@@ -39,6 +40,7 @@ public class ApplicationLifetime {
 
     @CalledByNative
     public static void terminate(boolean restart) {
+        IncognitoNotificationManager.dismissIncognitoNotification();
         for (Observer observer : sObservers) {
             observer.onTerminate(restart);
         }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -268,6 +268,8 @@ import java.util.Set;
 import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.function.DoubleConsumer;
 
+import org.chromium.chrome.browser.ApplicationLifetime;
+
 /**
  * This is the main activity for ChromeMobile when not running in document mode. All the tabs are
  * accessible via a chrome specific tab switching UI.
@@ -2960,6 +2962,8 @@ public class ChromeTabbedActivity extends ChromeActivity<ChromeActivityComponent
         } else if (id == R.id.close_tab) {
             getCurrentTabModel().closeTab(currentTab, false, true);
             RecordUserAction.record("MobileTabClosed");
+        } else if (id == R.id.exit_id) {
+            ApplicationLifetime.terminate(false);
         } else if (id == R.id.close_all_tabs_menu_id) {
             // Close both incognito and normal tabs.
             CloseAllTabsDialog.show(
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
@@ -62,6 +62,7 @@ import org.chromium.chrome.R;
 import org.chromium.chrome.browser.ActivityTabProvider;
 import org.chromium.chrome.browser.ActivityUtils;
 import org.chromium.chrome.browser.AppHooks;
+import org.chromium.chrome.browser.ApplicationLifetime;
 import org.chromium.chrome.browser.ChromeActivitySessionTracker;
 import org.chromium.chrome.browser.ChromeApplicationImpl;
 import org.chromium.chrome.browser.ChromeKeyboardVisibilityDelegate;
@@ -2597,6 +2598,11 @@ public abstract class ChromeActivity<C extends ChromeActivityComponent>
             return true;
         }
 
+        if (id == R.id.exit_id) {
+            ApplicationLifetime.terminate(false);
+            return true;
+        }
+
         if (id == R.id.update_menu_id) {
             UpdateMenuItemHelper.getInstance(
                             getProfileProviderSupplier().get().getOriginalProfile())
diff --git a/chrome/browser/ui/android/strings/android_chrome_strings.grd b/chrome/browser/ui/android/strings/android_chrome_strings.grd
GIT binary patch
delta 82
zcmX>yU18S@g@zW!7N!>F7M3lnvPmqi5uPE_16MGMiKJF!mMA0@<(C(y7U?NOJ9{_=
k=}r#_WEEj@t(e|;l2v!Qf;TH`yKE8&vu&46Vqd-z0BeUDU;qFB

delta 33
ncmdlrL*dADg@zW!7N!>F7M3lnvPtcelURY6ZTsXT_T?)9*y{|&

-- 
2.39.2

