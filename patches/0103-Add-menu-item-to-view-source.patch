From ba1e9e688c014ac628792249a3530a8ee2ea3005 Mon Sep 17 00:00:00 2001
From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Mon, 13 Jul 2020 00:37:06 +0200
Subject: [PATCH 103/177] Add menu item to view source

---
 chrome/android/java/res/menu/custom_tabs_menu.xml  |  3 +++
 chrome/android/java/res/menu/main_menu.xml         |  3 +++
 .../chrome/browser/ChromeTabbedActivity.java       |  2 ++
 .../chrome/browser/app/ChromeActivity.java         |  5 +++++
 .../app/appmenu/AppMenuPropertiesDelegateImpl.java | 14 ++++++++++++++
 .../CustomTabAppMenuPropertiesDelegate.java        |  1 +
 .../ui/android/strings/android_chrome_strings.grd  |  4 ++++
 7 files changed, 32 insertions(+)

diff --git a/chrome/android/java/res/menu/custom_tabs_menu.xml b/chrome/android/java/res/menu/custom_tabs_menu.xml
index 0a7b7f0016..ed64d79177 100644
--- a/chrome/android/java/res/menu/custom_tabs_menu.xml
+++ b/chrome/android/java/res/menu/custom_tabs_menu.xml
@@ -46,6 +46,9 @@
         <item android:id="@+id/add_to_homescreen_id"
             android:title="@string/menu_add_to_homescreen"
             android:orderInCategory="2" />
+        <item android:id="@+id/view_source_id"
+            android:title="@string/view_source"
+            android:orderInCategory="2" />
         <item android:id="@+id/open_webapk_id"
             android:title="@string/menu_open_webapk"
             android:orderInCategory="2" />
diff --git a/chrome/android/java/res/menu/main_menu.xml b/chrome/android/java/res/menu/main_menu.xml
index b0fcd4a29a..a7eca1a6a0 100644
--- a/chrome/android/java/res/menu/main_menu.xml
+++ b/chrome/android/java/res/menu/main_menu.xml
@@ -106,6 +106,9 @@
         <item android:id="@+id/add_to_homescreen_id"
             android:title="@string/menu_add_to_homescreen"
             android:icon="@drawable/ic_add_to_home_screen" />
+        <item android:id="@+id/view_source_id"
+            android:title="@string/view_source"
+            android:icon="@drawable/ic_drive_document_24dp" />
         <item android:id="@+id/open_webapk_id"
             android:title="@string/menu_open_webapk"
             android:icon="@drawable/ic_add_to_home_screen" />
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
index 8d0dfb23ab..e35d0f177f 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -2097,6 +2097,8 @@ public class ChromeTabbedActivity extends ChromeActivity<ChromeActivityComponent
                 NewTabPageUma.recordAction(NewTabPageUma.ACTION_OPENED_DOWNLOADS_MANAGER);
             }
             RecordUserAction.record("MobileMenuDownloadManager");
+        } else if (id == R.id.view_source_id) {
+            currentTab.getWebContents().getNavigationController().loadUrl(new LoadUrlParams("view-source:"+currentTab.getUrl().getSpec()));
         } else if (id == R.id.open_recently_closed_tab) {
             TabModel currentModel = mTabModelSelector.getCurrentModel();
             if (!currentModel.isIncognito()) currentModel.openMostRecentlyClosedTab();
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
index 8d8f1e9f2d..dafabb0caf 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
@@ -2558,6 +2558,11 @@ public abstract class ChromeActivity<C extends ChromeActivityComponent>
             return true;
         }
 
+        if (id == R.id.view_source_id) {
+            currentTab.getWebContents().getNavigationController().loadUrl(new LoadUrlParams("view-source:"+currentTab.getUrl().getSpec()));
+            return true;
+        }
+
         if (id == R.id.request_desktop_site_id || id == R.id.request_desktop_site_check_id) {
             boolean usingDesktopUserAgent =
                     currentTab.getWebContents().getNavigationController().getUseDesktopUserAgent();
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java b/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java
index b52749bcfd..e73e0823c0 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java
@@ -514,6 +514,7 @@ public class AppMenuPropertiesDelegateImpl implements AppMenuPropertiesDelegate
                         isChromeScheme, isFileScheme, isContentScheme, isIncognito, url));
 
         updateRequestDesktopSiteMenuItem(menu, currentTab, true /* can show */, isChromeScheme);
+        updateViewSourceMenuItem(menu, currentTab);
 
         updateAutoDarkMenuItem(menu, currentTab, isChromeScheme);
 
@@ -1161,6 +1162,19 @@ public class AppMenuPropertiesDelegateImpl implements AppMenuPropertiesDelegate
         stopPriceTrackingMenuItem.setVisible(priceTrackingEnabled);
     }
 
+    /**
+     * Updates the view source menu item's state.
+     *
+     * @param menu {@link Menu} for view source.
+     * @param currentTab      Current tab being displayed.
+     */
+    protected void updateViewSourceMenuItem(
+            Menu menu, Tab currentTab) {
+        MenuItem viewSourceMenuItem = menu.findItem(R.id.view_source_id);
+        String url = currentTab.getUrl().getSpec();
+        viewSourceMenuItem.setVisible(!url.isEmpty() && !url.startsWith("view-source:"));
+    }
+
     /**
      * Updates the request desktop site item's state.
      *
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabAppMenuPropertiesDelegate.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabAppMenuPropertiesDelegate.java
index dbf4925cf3..7bd11f0b0a 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabAppMenuPropertiesDelegate.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabAppMenuPropertiesDelegate.java
@@ -216,6 +216,7 @@ public class CustomTabAppMenuPropertiesDelegate extends AppMenuPropertiesDelegat
 
             updateRequestDesktopSiteMenuItem(
                     menu, currentTab, requestDesktopSiteVisible, isChromeScheme);
+            updateViewSourceMenuItem(menu, currentTab);
             prepareAddToHomescreenMenuItem(menu, currentTab, addToHomeScreenVisible);
         }
     }
diff --git a/chrome/browser/ui/android/strings/android_chrome_strings.grd b/chrome/browser/ui/android/strings/android_chrome_strings.grd
index 8773128678..024f072561 100644
--- a/chrome/browser/ui/android/strings/android_chrome_strings.grd
+++ b/chrome/browser/ui/android/strings/android_chrome_strings.grd
@@ -299,6 +299,10 @@ CHAR_LIMIT guidelines:
         Sign-in verifications
       </message>
 
+      <message name="IDS_VIEW_SOURCE" desc="Title for the menu command to view the source of the current page. [CHAR-LIMIT=40]">
+        View source
+      </message>
+
       <message name="IDS_UNSUPPORTED" desc="Message displayed to the user when an attempted action is not supported.">
         Unsupported
       </message>
-- 
2.35.1

